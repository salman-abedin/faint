#!/bin/sh
#
# A fuzzy file explorer
#
# Dpendencies:
#              sed, awk, fzf, faint-launch, faint-config, faint-fetch-config
#              faint-explore, faint-bookmark & faint-operate
#
# Usage: faint (launch on the current directory)
#        faint <PATH> (explore certain directories)
#        faint -l (launch on the last visited directory)

. faint-config

DATA_PATH=$HOME/.local/share/faint
<<<<<<< HEAD

export DEPTH_PATH=/tmp/FAINT_DEPTH
export LAST_PATH=/tmp/FAINT_LAST_$$
<<<<<<< HEAD
export FINAL_PATH=/tmp/FAINT_FINAL
export FILTERS_PATH=$HOME/.local/share/faint/FAINT_FILTERS
=======
=======
>>>>>>> 1e52e2e ()
export FINAL_PATH=$DATA_PATH/FAINT_FINAL
export FILTERS_PATH=$DATA_PATH/FAINT_FILTERS
<<<<<<< HEAD
<<<<<<< HEAD
>>>>>>> 72bd26b (fixed some minor bugs)
=======
=======
export BOOKMARKS_PATH=$DATA_PATH/FAINT_BOOKMARKS
<<<<<<< HEAD
>>>>>>> bbf9855 ()
export FAINT_PID=$$
=======

export SHOW_HIDDEN_PATH=/tmp/FAINT_SHOW_HIDDEN
export USE_FILTERS_PATH=/tmp/FAINT_USE_FILTERS

export MAX_DEPTH_PATH=/tmp/FAINT_MAX_DEPTH
export LAST_PATH=/tmp/FAINT_LAST_$$
>>>>>>> 1e52e2e ()
export EDITOR_FILE_PATH=/tmp/FAINT_EDITOR_FILE
>>>>>>> 3a8f544 ()

export FAINT_PID=$$

export FZF_DEFAULT_OPTS="\
   $FZF_DEFAULT_OPTS
   --reverse --border --no-info --margin 15%,30% --no-color --header ''
   -m --cycle
   --bind \"$KEY_QUIT:cancel\"
   --bind \"$KEY_OPERATE:execute(faint-operate {+})+reload(faint-explore -r)+clear-query+top\"
   --bind \"$KEY_BACK:reload(faint-explore -b)+clear-query+top\"
   --bind \"$KEY_SHELL:abort+execute(kill -35 $$)\"
   --bind \"$KEY_EDIT:execute(faint-launch -e {})+clear-query+top\"

   --bind \"$KEY_UP:up\"
   --bind \"$KEY_DOWN:down\"
   --bind \"$KEY_REFRESH:reload(faint-explore -r)\"

   --bind \"$KEY_MARK_ALL:toggle-all\"
   --bind \"$KEY_MARK_DOWN:toggle-down\"
   --bind \"$KEY_MARK_UP:toggle-up\"

   --bind \"$KEY_BOOKMARK_BROWSE:execute(faint-bookmark -b)+reload(faint-explore -r)+clear-query+top\"
   --bind \"$KEY_BOOKMARK_ADD:execute(faint-bookmark -a)\"

   --bind \"$KEY_LAUNCH:reload(faint-explore -c {})+clear-query+top\"

   --bind \"$KEY_TOGGLE_FILTERS:reload(faint-explore -t filters)\"
   --bind \"$KEY_TOGGLE_HIDDEN:reload(faint-explore -t hidden)\"

   --bind \"$KEY_DEPTH_PLUS:reload(faint-explore -d plus)\"
   --bind \"$KEY_DEPTH_MINUS:reload(faint-explore -d minus)\"
   --bind \"$KEY_DEPTH_RESET:reload(faint-explore -d reset)\"

   "

change_root() {
   read -r LAST_DIR < "$LAST_PATH"
   cd "$LAST_DIR" || exit 1
   exec "$SHELL"
}

edit() {
   read -r FILE < "$EDITOR_FILE_PATH"
   $EDITOR "$FILE" || "$VISUAL" "$FILE"
   read -r LAST_DIR < "$LAST_PATH"
   exec "$0" "$LAST_DIR"
}

init() {
   echo "$PWD" > "$LAST_PATH"

   echo "$MAX_DEPTH" > $MAX_DEPTH_PATH
   echo "$SHOW_HIDDEN" > $SHOW_HIDDEN_PATH
   echo "$USE_FILTERS" > $USE_FILTERS_PATH

   [ -d "$DATA_PATH" ] || mkdir -p "$DATA_PATH"
}

process_args() {
   case $1 in
      -l) read -r DEST < "$FINAL_PATH" ;;
      *) DEST=$1 ;;
   esac
}

process_args "$@"
init

trap 'change_root' RTMIN+1
trap 'edit' RTMIN+2
trap 'ns yo' RTMIN+3

faint-explore "${DEST:-$PWD}" | fzf
mv "$LAST_PATH" "$FINAL_PATH"
